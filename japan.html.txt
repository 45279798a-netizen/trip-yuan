<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TOKYO OS Travel Planner</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        fadeIn: 'fadeIn 0.3s ease-in-out',
                        slideUp: 'slideUp 0.4s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* 隱藏 Scrollbar 但保持功能 */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Leaflet Marker Icon 修正 */
        .custom-marker-icon {
            background: transparent;
            border: none;
        }
    </style>
</head>
<body class="bg-black text-white overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          MapPin, Clock, Wallet, Plus, Trash2, 
          Sun, ShoppingBag, Camera, Train, Utensils, LayoutGrid,
          Edit3, X, Map as MapIcon, List, 
          ZoomIn, ZoomOut, Users, Image as ImageIcon, Settings, 
          PieChart, ArrowRight, Link as LinkIcon,
          Search, Globe, Hotel, CornerDownLeft,
          Navigation, Calendar, UserPlus, Minus, Calculator, Check, RefreshCw, LocateFixed, Upload,
          Zap, Bell, MoreVertical, ExternalLink, Image, Palette, Moon, Cloud,
          Leaf, Mountain, Coffee, Map, Plane, Anchor, AlertTriangle, HelpCircle, Loader2, Hash, Snowflake, CloudRain, Wand2,
          Waves, Sunset, Flower2, Crown, Box, Trees, Wind, Droplets, Cpu, Code, Shield
        } from 'lucide-react';

        // --- 3.0 版：20 種主題全集 ---
        const THEMES = {
          // 1. 經典
          cyberpunk: {
            id: 'cyberpunk', name: 'Cyberpunk', icon: Zap,
            tileLayer: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            attribution: '© CARTO',
            colors: { bg: 'bg-slate-950', card: 'bg-slate-900', cardBlur: 'bg-slate-900/80', text: 'text-slate-200', subtext: 'text-slate-400', border: 'border-slate-800', accent: 'text-cyan-400', accentBg: 'bg-cyan-500', accentBorder: 'border-cyan-500', highlight: 'text-emerald-400', mapBg: '#020617', navBar: 'bg-slate-950/80' }
          },
          // 2. 日系
          sakura: {
            id: 'sakura', name: '櫻花', icon: Sun,
            tileLayer: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            attribution: '© OSM',
            colors: { bg: 'bg-pink-50', card: 'bg-white', cardBlur: 'bg-white/80', text: 'text-slate-800', subtext: 'text-slate-500', border: 'border-pink-200', accent: 'text-pink-500', accentBg: 'bg-pink-500', accentBorder: 'border-pink-400', highlight: 'text-rose-500', mapBg: '#fff1f2', navBar: 'bg-white/80' }
          },
          // 3. 暗色
          midnight: {
            id: 'midnight', name: '午夜', icon: Moon,
            tileLayer: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            attribution: '© CARTO',
            colors: { bg: 'bg-indigo-950', card: 'bg-indigo-900', cardBlur: 'bg-indigo-900/80', text: 'text-indigo-100', subtext: 'text-indigo-300', border: 'border-indigo-800', accent: 'text-violet-400', accentBg: 'bg-violet-500', accentBorder: 'border-violet-500', highlight: 'text-amber-400', mapBg: '#0f172a', navBar: 'bg-indigo-950/80' }
          },
          // 4. 自然
          matcha: {
            id: 'matcha', name: '抹茶', icon: Leaf,
            tileLayer: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            attribution: '© CARTO',
            colors: { bg: 'bg-emerald-950', card: 'bg-emerald-900', cardBlur: 'bg-emerald-900/80', text: 'text-emerald-50', subtext: 'text-emerald-300/70', border: 'border-emerald-800', accent: 'text-lime-400', accentBg: 'bg-lime-500', accentBorder: 'border-lime-500', highlight: 'text-orange-300', mapBg: '#022c22', navBar: 'bg-emerald-950/80' }
          },
          // 5. 冷色
          fuji: {
            id: 'fuji', name: '富士', icon: Mountain,
            tileLayer: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
            attribution: '© CARTO',
            colors: { bg: 'bg-slate-50', card: 'bg-white', cardBlur: 'bg-white/90', text: 'text-slate-900', subtext: 'text-slate-500', border: 'border-slate-200', accent: 'text-blue-600', accentBg: 'bg-blue-600', accentBorder: 'border-blue-500', highlight: 'text-red-500', mapBg: '#f8fafc', navBar: 'bg-slate-50/90' }
          },
          // 6. 復古
          retro: {
            id: 'retro', name: '昭和', icon: Coffee,
            tileLayer: 'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
            attribution: '© OSM',
            colors: { bg: 'bg-stone-950', card: 'bg-stone-900', cardBlur: 'bg-stone-900/80', text: 'text-stone-200', subtext: 'text-stone-400', border: 'border-stone-800', accent: 'text-orange-400', accentBg: 'bg-orange-500', accentBorder: 'border-orange-500', highlight: 'text-yellow-400', mapBg: '#1c1917', navBar: 'bg-stone-950/80' }
          },
          // 7. 海洋
          ocean: {
            id: 'ocean', name: '深海', icon: Waves,
            tileLayer: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
            attribution: '© CARTO',
            colors: { bg: 'bg-cyan-950', card: 'bg-cyan-900', cardBlur: 'bg-cyan-900/80', text: 'text-cyan-50', subtext: 'text-cyan-300', border: 'border-cyan-800', accent: 'text-sky-400', accentBg: 'bg-sky-500', accentBorder: 'border-sky-400', highlight: 'text-teal-300', mapBg: '#083344', navBar: 'bg-cyan-950/80' }
          },
          // 8. 黃昏
          sunset: {
            id: 'sunset', name: '夕陽', icon: Sunset,
            tileLayer: 'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
            attribution: '© OSM',
            colors: { bg: 'bg-orange-950', card: 'bg-orange-900', cardBlur: 'bg-orange-900/80', text: 'text-orange-50', subtext: 'text-orange-300', border: 'border-orange-800', accent: 'text-yellow-400', accentBg: 'bg-yellow-500', accentBorder: 'border-yellow-500', highlight: 'text-red-400', mapBg: '#431407', navBar: 'bg-orange-950/80' }
          },
          // 9. 夢幻
          lavender: {
            id: 'lavender', name: '紫藤', icon: Flower2,
            tileLayer: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
            attribution: '© CARTO',
            colors: { bg: 'bg-purple-50', card: 'bg-white', cardBlur: 'bg-white/90', text: 'text-purple-950', subtext: 'text-purple-500', border: 'border-purple-200', accent: 'text-fuchsia-600', accentBg: 'bg-fuchsia-600', accentBorder: 'border-fuchsia-500', highlight: 'text-violet-600', mapBg: '#fdf4ff', navBar: 'bg-purple-50/90' }
          },
          // 10. 奢華
          luxury: {
            id: 'luxury', name: '黑金', icon: Crown,
            tileLayer: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            attribution: '© CARTO',
            colors: { bg: 'bg-neutral-950', card: 'bg-neutral-900', cardBlur: 'bg-neutral-900/90', text: 'text-neutral-200', subtext: 'text-neutral-500', border: 'border-yellow-900', accent: 'text-yellow-500', accentBg: 'bg-yellow-600', accentBorder: 'border-yellow-600', highlight: 'text-amber-300', mapBg: '#0a0a0a', navBar: 'bg-neutral-950/90' }
          },
          // 11. 工業
          industrial: {
            id: 'industrial', name: '工業', icon: Box,
            tileLayer: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', 
            attribution: '© CARTO',
            colors: { bg: 'bg-zinc-100', card: 'bg-white', cardBlur: 'bg-white/80', text: 'text-zinc-800', subtext: 'text-zinc-500', border: 'border-zinc-300', accent: 'text-zinc-900', accentBg: 'bg-zinc-800', accentBorder: 'border-zinc-800', highlight: 'text-red-600', mapBg: '#f4f4f5', navBar: 'bg-zinc-100/90' }
          },
          // 12. 森林
          forest: {
            id: 'forest', name: '森林', icon: Trees,
            tileLayer: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
            attribution: '© CARTO',
            colors: { bg: 'bg-green-900', card: 'bg-green-800', cardBlur: 'bg-green-800/80', text: 'text-green-50', subtext: 'text-green-300', border: 'border-green-700', accent: 'text-emerald-400', accentBg: 'bg-emerald-500', accentBorder: 'border-emerald-500', highlight: 'text-lime-300', mapBg: '#064e3b', navBar: 'bg-green-900/80' }
          },
          // 13. 秋日
          autumn: {
            id: 'autumn', name: '楓葉', icon: Wind,
            tileLayer: 'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
            attribution: '© OSM',
            colors: { bg: 'bg-amber-50', card: 'bg-white', cardBlur: 'bg-white/90', text: 'text-amber-900', subtext: 'text-amber-600', border: 'border-amber-200', accent: 'text-orange-600', accentBg: 'bg-orange-600', accentBorder: 'border-orange-500', highlight: 'text-red-600', mapBg: '#fffbeb', navBar: 'bg-amber-50/90' }
          },
          // 14. 螢光
          neon: {
            id: 'neon', name: '螢光', icon: Zap,
            tileLayer: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            attribution: '© CARTO',
            colors: { bg: 'bg-black', card: 'bg-gray-900', cardBlur: 'bg-gray-900/90', text: 'text-white', subtext: 'text-gray-400', border: 'border-fuchsia-600', accent: 'text-fuchsia-400', accentBg: 'bg-fuchsia-600', accentBorder: 'border-fuchsia-500', highlight: 'text-yellow-300', mapBg: '#000000', navBar: 'bg-black/90' }
          },
          // 15. 薄荷
          mint: {
            id: 'mint', name: '薄荷', icon: Droplets,
            tileLayer: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
            attribution: '© CARTO',
            colors: { bg: 'bg-teal-50', card: 'bg-white', cardBlur: 'bg-white/80', text: 'text-teal-900', subtext: 'text-teal-600', border: 'border-teal-200', accent: 'text-teal-500', accentBg: 'bg-teal-500', accentBorder: 'border-teal-400', highlight: 'text-cyan-600', mapBg: '#f0fdfa', navBar: 'bg-teal-50/80' }
          },
          // 16. 吸血鬼
          dracula: {
            id: 'dracula', name: 'Dracula', icon: Moon,
            tileLayer: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            attribution: '© CARTO',
            colors: { bg: 'bg-[#282a36]', card: 'bg-[#44475a]', cardBlur: 'bg-[#44475a]/90', text: 'text-[#f8f8f2]', subtext: 'text-[#bd93f9]', border: 'border-[#6272a4]', accent: 'text-[#ff79c6]', accentBg: 'bg-[#ff79c6]', accentBorder: 'border-[#ff79c6]', highlight: 'text-[#50fa7b]', mapBg: '#282a36', navBar: 'bg-[#282a36]/90' }
          },
          // 17. 北歐
          nordic: {
            id: 'nordic', name: '北歐', icon: Snowflake,
            tileLayer: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
            attribution: '© CARTO',
            colors: { bg: 'bg-slate-100', card: 'bg-white', cardBlur: 'bg-white/90', text: 'text-slate-700', subtext: 'text-slate-400', border: 'border-slate-200', accent: 'text-blue-400', accentBg: 'bg-blue-400', accentBorder: 'border-blue-400', highlight: 'text-indigo-400', mapBg: '#f1f5f9', navBar: 'bg-slate-100/90' }
          },
          // 18. 暖陽
          solar: {
            id: 'solar', name: '暖陽', icon: Sun,
            tileLayer: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            attribution: '© OSM',
            colors: { bg: 'bg-yellow-50', card: 'bg-white', cardBlur: 'bg-white/90', text: 'text-yellow-900', subtext: 'text-yellow-600', border: 'border-yellow-200', accent: 'text-yellow-500', accentBg: 'bg-yellow-500', accentBorder: 'border-yellow-500', highlight: 'text-orange-500', mapBg: '#fefce8', navBar: 'bg-yellow-50/90' }
          },
          // 19. 駭客
          matrix: {
            id: 'matrix', name: 'Matrix', icon: Code,
            tileLayer: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            attribution: '© CARTO',
            colors: { bg: 'bg-black', card: 'bg-black', cardBlur: 'bg-black/90', text: 'text-green-500', subtext: 'text-green-700', border: 'border-green-800', accent: 'text-green-400', accentBg: 'bg-green-600', accentBorder: 'border-green-500', highlight: 'text-white', mapBg: '#000000', navBar: 'bg-black/90' }
          },
          // 20. 鋼彈
          gundam: {
            id: 'gundam', name: '鋼彈', icon: Shield,
            tileLayer: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
            attribution: '© CARTO',
            colors: { bg: 'bg-gray-100', card: 'bg-white', cardBlur: 'bg-white/90', text: 'text-blue-900', subtext: 'text-gray-500', border: 'border-red-600', accent: 'text-blue-600', accentBg: 'bg-blue-600', accentBorder: 'border-blue-600', highlight: 'text-yellow-500', mapBg: '#f3f4f6', navBar: 'bg-gray-100/90' }
          }
        };

        const DEFAULT_MEMBERS = ["我", "旅伴A", "旅伴B"];
        const CATEGORIES = {
          sightseeing: { label: '景點', icon: <Camera size={14} />, color: '#d946ef', bg: 'bg-fuchsia-500/20', text: 'text-fuchsia-300', border: 'border-fuchsia-500/50', hex: '#d946ef' },
          food: { label: '美食', icon: <Utensils size={14} />, color: '#f97316', bg: 'bg-orange-500/20', text: 'text-orange-300', border: 'border-orange-500/50', hex: '#f97316' },
          shopping: { label: '逛街', icon: <ShoppingBag size={14} />, color: '#ec4899', bg: 'bg-pink-500/20', text: 'text-pink-300', border: 'border-pink-500/50', hex: '#ec4899' },
          transport: { label: '交通', icon: <Train size={14} />, color: '#06b6d4', bg: 'bg-cyan-500/20', text: 'text-cyan-300', border: 'border-cyan-500/50', hex: '#06b6d4' },
          other: { label: '其他', icon: <LayoutGrid size={14} />, color: '#94a3b8', bg: 'bg-slate-500/20', text: 'text-slate-300', border: 'border-slate-500/50', hex: '#94a3b8' },
        };

        const REGION_COORDS = {
          tokyo: { lat: 35.6895, lng: 139.6917, name: '東京', zoom: 12 },
          osaka: { lat: 34.6937, lng: 135.5022, name: '大阪', zoom: 13 }
        };

        const REAL_LOCATIONS = {
          'Narita Airport': { lat: 35.7719, lng: 140.3929 }, '成田': { lat: 35.7719, lng: 140.3929 },
          'Haneda Airport': { lat: 35.5494, lng: 139.7798 }, '羽田': { lat: 35.5494, lng: 139.7798 },
          'Shinjuku': { lat: 35.6915, lng: 139.7000 }, '新宿': { lat: 35.6915, lng: 139.7000 },
          'Shibuya': { lat: 35.6580, lng: 139.7016 }, '澀谷': { lat: 35.6580, lng: 139.7016 },
          'Tokyo Station': { lat: 35.6812, lng: 139.7671 }, '東京車站': { lat: 35.6812, lng: 139.7671 },
          'Asakusa': { lat: 35.7147, lng: 139.7966 }, '淺草': { lat: 35.7147, lng: 139.7966 },
          'Tokyo Skytree': { lat: 35.7100, lng: 139.8107 }, '晴空塔': { lat: 35.7100, lng: 139.8107 },
          'Disney': { lat: 35.6329, lng: 139.8804 }, '迪士尼': { lat: 35.6329, lng: 139.8804 },
          'Osaka Station': { lat: 34.7025, lng: 135.4959 }, '大阪車站': { lat: 34.7025, lng: 135.4959 },
          'Dotonbori': { lat: 34.6687, lng: 135.5013 }, '道頓堀': { lat: 34.6687, lng: 135.5013 },
          'USJ': { lat: 34.6654, lng: 135.4323 }, '環球影城': { lat: 34.6654, lng: 135.4323 },
          'Kansai Airport': { lat: 34.4320, lng: 135.2304 }, '關西機場': { lat: 34.4320, lng: 135.2304 },
          'Taoyuan': { lat: 25.0797, lng: 121.2342 }, '桃園': { lat: 25.0797, lng: 121.2342 }
        };

        const INITIAL_ITINERARY = [
          { id: '0', day: 1, time: '09:00', title: '桃園機場出發', category: 'transport', location: '桃園機場', coordinates: { lat: 25.0797, lng: 121.2342 }, mapUrl: '', notes: '第二航廈長榮', cost: { shared: 0, individuals: { "我": 0, "旅伴A": 0 } } },
          { id: '1', day: 1, time: '14:00', title: '成田機場抵達', category: 'transport', location: '成田機場', coordinates: { lat: 35.7719, lng: 140.3929 }, mapUrl: '', notes: '搭乘 Skyliner', cost: { total: 5000, payer: "我", mode: "even", targets: {}, customAmounts: {} } },
          { id: '2', day: 1, time: '18:00', title: '新宿歌舞伎町', category: 'sightseeing', location: '新宿', coordinates: { lat: 35.6915, lng: 139.7000 }, mapUrl: '', notes: '晚餐吃燒肉', cost: { total: 0, payer: "我", mode: "even", targets: {}, customAmounts: {} } },
          { id: '3', day: 2, time: '09:00', title: '淺草雷門', category: 'sightseeing', location: '淺草', coordinates: { lat: 35.7147, lng: 139.7966 }, mapUrl: '', notes: '穿和服拍照', cost: { shared: 200, individuals: { "我": 5000, "旅伴A": 5000 } } },
          { id: '4', day: 3, time: '10:00', title: '環球影城 USJ', category: 'sightseeing', location: '環球影城', coordinates: { lat: 34.6654, lng: 135.4323 }, mapUrl: '', notes: '大阪行程測試', cost: { total: 8000, payer: "我", mode: "even", targets: {}, customAmounts: {} } },
          { id: '5', day: 3, time: '19:00', title: '道頓堀跑跑人', category: 'food', location: '道頓堀', coordinates: { lat: 34.6687, lng: 135.5013 }, mapUrl: '', notes: '章魚燒', cost: { total: 2000, payer: "我", mode: "even", targets: {}, customAmounts: {} } },
        ];

        const fetchCoordinates = async (locationName) => {
          if (!locationName) return null;
          const cachedKey = Object.keys(REAL_LOCATIONS).find(k => locationName.toLowerCase().includes(k.toLowerCase()));
          if (cachedKey) return REAL_LOCATIONS[cachedKey];
          try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}&limit=1`);
            const data = await response.json();
            if (data && data.length > 0) { return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) }; }
          } catch (error) { console.error("Geocoding error:", error); }
          return null;
        };

        const calculateBalances = (itinerary, members) => {
          const balances = {};
          members.forEach(m => balances[m] = 0);
          itinerary.forEach(item => {
            const { total, payer, mode, targets, customAmounts } = item.cost || {};
            if (!total || total <= 0) return;
            if (balances[payer] !== undefined) balances[payer] += parseFloat(total);
            if (mode === 'even') {
              const involved = members.filter(m => targets && targets[m]);
              if (involved.length > 0) { const share = total / involved.length; involved.forEach(m => balances[m] -= share); }
            } else if (mode === 'custom') {
              members.forEach(m => { const amt = customAmounts && customAmounts[m] ? parseFloat(customAmounts[m]) : 0; balances[m] -= amt; });
            }
          });
          return balances;
        };

        // --- Components ---

        const CurrencyConverter = ({theme}) => {
          const [jpy, setJpy] = useState('');
          const [rate, setRate] = useState(0.215);
          const [twd, setTwd] = useState('');
          return (
            <div className={`${theme.colors.card} p-4 rounded-xl border ${theme.colors.border} mb-6`}>
              <div className="flex justify-between items-center mb-3">
                <h3 className={`text-sm font-bold ${theme.colors.subtext} flex items-center gap-2`}><Calculator size={16} className={theme.colors.accent}/> 匯率換算</h3>
                <div className={`flex items-center gap-1 ${theme.colors.bg} px-2 py-1 rounded border ${theme.colors.border}`}><span className={`text-[10px] ${theme.colors.subtext}`}>匯率:</span><input type="number" value={rate} onChange={(e) => { setRate(e.target.value); if(jpy) setTwd(Math.round(jpy * e.target.value).toString()); }} className={`w-12 bg-transparent ${theme.colors.accent} text-xs font-mono outline-none text-right`}/></div>
              </div>
              <div className="flex items-center gap-2">
                <div className="flex-1 relative"><span className={`absolute left-3 top-1/2 -translate-y-1/2 ${theme.colors.subtext} text-xs font-bold`}>JPY</span><input type="number" value={jpy} onChange={(e) => { setJpy(e.target.value); setTwd(e.target.value ? Math.round(e.target.value * rate).toString() : ''); }} className={`w-full ${theme.colors.bg} border ${theme.colors.border} rounded-lg py-2 pl-10 pr-2 ${theme.colors.text} font-mono focus:${theme.colors.accentBorder} outline-none`} placeholder="0"/></div>
                <div className={theme.colors.subtext}><ArrowRight size={16}/></div>
                <div className="flex-1 relative"><span className={`absolute left-3 top-1/2 -translate-y-1/2 ${theme.colors.subtext} text-xs font-bold`}>TWD</span><div className={`w-full ${theme.colors.bg} border ${theme.colors.border} rounded-lg py-2 pl-10 pr-2 ${theme.colors.highlight} font-mono font-bold`}>{twd ? Number(twd).toLocaleString() : '0'}</div></div>
              </div>
            </div>
          );
        };

        const BudgetReportModal = ({ isOpen, onClose, itinerary, travelers, theme }) => {
          if (!isOpen) return null;
          const grandTotal = itinerary.reduce((sum, item) => sum + (item.cost?.total || 0), 0);
          const balances = useMemo(() => calculateBalances(itinerary, travelers), [itinerary, travelers]);
          return (
            <div className="fixed inset-0 z-[100] flex items-end justify-center pointer-events-auto">
              <div className="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onClick={onClose}/>
              <div className={`${theme.colors.card} w-full max-w-lg rounded-t-3xl p-6 relative z-10 shadow-2xl border-t ${theme.colors.border} animate-slideUp max-h-[90vh] overflow-y-auto`}>
                <div className="flex justify-between items-center mb-6"><h2 className={`text-2xl font-bold ${theme.colors.text} flex items-center gap-2`}><PieChart className={theme.colors.accent}/> 財務總結</h2><button onClick={onClose} className={`p-2 ${theme.colors.bg} rounded-full hover:opacity-80 ${theme.colors.subtext}`}><X size={20}/></button></div>
                <CurrencyConverter theme={theme}/>
                <div className={`bg-gradient-to-r from-cyan-900 to-blue-900 text-white p-6 rounded-2xl shadow-lg border border-cyan-500/20 mb-6`}><div className="text-cyan-200 text-xs font-bold uppercase tracking-wider mb-1">行程總費用</div><div className="text-4xl font-mono font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-200 to-white">¥{grandTotal.toLocaleString()}</div></div>
                <div className="space-y-3 mb-8"><div className="flex justify-between items-center"><h3 className={`text-sm font-bold ${theme.colors.subtext} uppercase tracking-wider`}>淨餘額結算</h3><span className={`text-[10px] ${theme.colors.subtext} ${theme.colors.bg} px-2 py-1 rounded`}>正=收錢 / 負=給錢</span></div>{travelers.map(member => { const bal = Math.round(balances[member] || 0); const isPositive = bal >= 0; return (<div key={member} className={`${theme.colors.bg} p-4 rounded-xl border ${theme.colors.border} flex justify-between items-center`}><span className={`font-bold ${theme.colors.text}`}>{member}</span><span className={`font-mono font-bold text-xl ${isPositive ? theme.colors.highlight : 'text-red-400'}`}>{isPositive ? '+' : ''}{bal.toLocaleString()}</span></div>); })}</div>
              </div>
            </div>
          );
        };

        const SettingsTab = ({ totalDays, setTotalDays, travelers, setTravelers, currentTheme, setTheme }) => {
          const [newMember, setNewMember] = useState("");
          const addMember = () => { if (newMember.trim()) { setTravelers([...travelers, newMember.trim()]); setNewMember(""); }};
          const removeMember = (index) => { if (travelers.length > 1) { const newList = [...travelers]; newList.splice(index, 1); setTravelers(newList); } else { alert("至少需要一位旅伴！"); }};
          
          return (
            <div className="p-6 space-y-8 pb-24 animate-fadeIn">
              <h2 className={`text-2xl font-bold ${currentTheme.colors.text} mb-6 flex items-center gap-3`}><Settings className={currentTheme.colors.accent} /> 設定</h2>
              
              <div className={`${currentTheme.colors.card} rounded-2xl p-5 border ${currentTheme.colors.border} shadow-lg`}>
                <h3 className={`${currentTheme.colors.subtext} font-bold mb-4 flex items-center gap-2`}><Palette size={18} className="text-fuchsia-400"/> 主題風格</h3>
                <div className="grid grid-cols-3 gap-3 max-h-[300px] overflow-y-auto pr-2">
                  {Object.values(THEMES).map(t => {
                    const ThemeIcon = t.icon;
                    return (
                      <button key={t.id} onClick={() => setTheme(t)} className={`flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all ${currentTheme.id === t.id ? `${t.colors.accentBorder} ${t.colors.bg}` : `${currentTheme.colors.border} ${currentTheme.colors.bg} opacity-60 hover:opacity-100`}`}>
                        <div className={`${t.colors.text} mb-2`}><ThemeIcon size={16}/></div>
                        <span className={`text-xs font-bold ${t.colors.text}`}>{t.name}</span>
                      </button>
                    );
                  })}
                </div>
              </div>

              <div className={`${currentTheme.colors.card} rounded-2xl p-5 border ${currentTheme.colors.border} shadow-lg`}>
                <h3 className={`${currentTheme.colors.subtext} font-bold mb-4 flex items-center gap-2`}><Calendar size={18} className="text-purple-400"/> 旅遊天數</h3>
                <div className={`flex items-center justify-between ${currentTheme.colors.bg} p-4 rounded-xl border ${currentTheme.colors.border}`}>
                  <button onClick={() => setTotalDays(Math.max(1, totalDays - 1))} className={`w-10 h-10 rounded-full ${currentTheme.colors.card} ${currentTheme.colors.subtext} flex items-center justify-center hover:opacity-80 active:scale-95 transition-all`}><Minus size={20}/></button>
                  <div className="text-center"><div className={`text-3xl font-bold ${currentTheme.colors.text} font-mono`}>{totalDays}</div><div className={`text-xs ${currentTheme.colors.subtext}`}>天</div></div>
                  <button onClick={() => setTotalDays(Math.min(30, totalDays + 1))} className={`w-10 h-10 rounded-full ${currentTheme.colors.accentBg} text-white flex items-center justify-center hover:opacity-90 active:scale-95 transition-all border ${currentTheme.colors.border}`}><Plus size={20}/></button>
                </div>
              </div>

              <div className={`${currentTheme.colors.card} rounded-2xl p-5 border ${currentTheme.colors.border} shadow-lg`}>
                <h3 className={`${currentTheme.colors.subtext} font-bold mb-4 flex items-center gap-2`}><Users size={18} className="text-orange-400"/> 旅團成員 ({travelers.length})</h3>
                <div className="space-y-3 mb-4">{travelers.map((m, idx) => (<div key={idx} className={`flex justify-between items-center ${currentTheme.colors.bg} px-4 py-3 rounded-xl border ${currentTheme.colors.border}`}><span className={`font-bold ${currentTheme.colors.text}`}>{m}</span><button onClick={() => removeMember(idx)} className={`${currentTheme.colors.subtext} p-1 hover:text-red-400 transition-colors`}><Trash2 size={16}/></button></div>))}</div>
                <div className="flex gap-2"><input type="text" value={newMember} onChange={e => setNewMember(e.target.value)} className={`flex-1 ${currentTheme.colors.bg} border ${currentTheme.colors.border} rounded-xl px-4 py-3 text-sm outline-none ${currentTheme.colors.text} placeholder-slate-500 focus:${currentTheme.colors.accentBorder} transition-colors`} placeholder="輸入名字..."/><button onClick={addMember} className={`${currentTheme.colors.card} ${currentTheme.colors.text} px-4 rounded-xl font-bold hover:opacity-80 border ${currentTheme.colors.border}`}><UserPlus size={20}/></button></div>
              </div>
            </div>
          );
        };

        const DashboardHeader = ({ memberCount, activeDay, onDayChange, totalDays, theme, activeRegion }) => {
          const [now, setNow] = useState(new Date());
          const [weather, setWeather] = useState({ temp: '--', icon: Sun, text: '載入中...', isDay: true });

          useEffect(() => { 
            const t = setInterval(() => setNow(new Date()), 1000); 
            
            // V69 Update: Dynamic weather fetching based on active region
            const fetchWeather = async () => {
                try {
                    const coords = REGION_COORDS[activeRegion];
                    if (!coords) return;

                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lng}&current_weather=true&timezone=Asia%2FTokyo`);
                    const data = await res.json();
                    if (data.current_weather) {
                        const { temperature, weathercode, is_day } = data.current_weather;
                        let Icon = Sun; let text = '晴朗';
                        if (weathercode <= 1) { Icon = Sun; text = '晴朗'; }
                        else if (weathercode <= 3) { Icon = Cloud; text = '多雲'; }
                        else if (weathercode <= 48) { Icon = Cloud; text = '有霧'; }
                        else if (weathercode <= 67) { Icon = CloudRain; text = '下雨'; }
                        else if (weathercode <= 77) { Icon = Snowflake; text = '下雪'; }
                        else if (weathercode <= 82) { Icon = CloudRain; text = '陣雨'; }
                        else if (weathercode <= 86) { Icon = Snowflake; text = '陣雪'; }
                        else { Icon = Zap; text = '雷雨'; }
                        setWeather({ temp: temperature, icon: Icon, text, isDay: is_day === 1 });
                    }
                } catch (e) { setWeather(prev => ({ ...prev, text: '離線' })); }
            };
            fetchWeather();
            const wInterval = setInterval(fetchWeather, 600000);
            return () => { clearInterval(t); clearInterval(wInterval); };
          }, [activeRegion]);

          const days = Array.from({ length: totalDays }, (_, i) => i + 1);
          const dateStr = now.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short' }).replace(/\//g, '.');
          const timeStr = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
          const WeatherIcon = weather.icon;
          const regionName = REGION_COORDS[activeRegion]?.name || '日本';

          return (
            <div className={`${theme.colors.navBar} backdrop-blur-md ${theme.colors.text} rounded-b-[2rem] shadow-[0_10px_30px_-10px_rgba(0,0,0,0.2)] z-30 relative overflow-hidden border-b ${theme.colors.border} flex-shrink-0 transition-colors duration-500`}>
              <div className="pt-5 px-6 pb-4 relative">
                <div className="flex justify-between items-start mb-6">
                  <div className="pt-1">
                    <h1 className={`text-3xl font-black tracking-wider ${theme.colors.text} flex items-center gap-2 font-mono italic`}>
                      TOKYO <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">OS</span> <span className={`text-[10px] not-italic ${theme.colors.subtext} border ${theme.colors.border} px-1 rounded ${theme.colors.bg}`}>v3.0</span>
                    </h1>
                    <div className={`text-xs ${theme.colors.subtext} mt-2 flex items-center gap-2`}>
                      <span className={`flex items-center gap-1 ${theme.colors.cardBlur} px-2 py-1 rounded-full border ${theme.colors.border} shadow-sm`}>
                        <Users size={10} className={theme.colors.accent}/> {memberCount} 人旅團
                      </span>
                      <span className={`flex items-center gap-1 ${theme.colors.cardBlur} px-2 py-1 rounded-full border ${theme.colors.border} shadow-sm`}>
                        <Zap size={10} className="text-yellow-400"/> 在線
                      </span>
                    </div>
                  </div>
                  <div className="text-right flex flex-col items-end">
                    <div className={`text-5xl font-black font-mono leading-[0.9] ${theme.colors.text} tracking-tighter drop-shadow-lg`}>{timeStr}</div>
                    <div className="flex items-center gap-2 mt-2">
                       <div className={`flex items-center gap-2 px-3 py-1 rounded-lg ${theme.colors.bg} border ${theme.colors.border} shadow-sm`}>
                          <Calendar size={12} className={theme.colors.accent} /> 
                          <span className={`text-[10px] font-bold ${theme.colors.subtext}`}>{dateStr}</span>
                       </div>
                       <div className={`flex items-center gap-2 px-3 py-1 rounded-lg ${theme.colors.accentBg} text-white shadow-md`}>
                         <WeatherIcon size={12} className={weather.text.includes('雨') ? 'text-blue-200' : 'text-yellow-100'}/> 
                         <span className="text-[10px] font-bold">{regionName} {weather.temp}°C {weather.text}</span>
                       </div>
                    </div>
                  </div>
                </div>
                <div className="flex gap-2 overflow-x-auto scrollbar-hide pb-2 pt-1">
                  {days.map(day => (
                    <button key={day} onClick={() => onDayChange(day)} className={`snap-start flex-shrink-0 flex flex-col items-center justify-center w-12 h-16 rounded-2xl transition-all border duration-300 relative overflow-hidden group ${activeDay === day ? `${theme.colors.card} ${theme.colors.accentBorder} shadow-lg scale-105` : `${theme.colors.bg} ${theme.colors.border} ${theme.colors.subtext} hover:opacity-80`}`}>
                      <div className={`absolute top-0 left-0 w-full h-1.5 ${activeDay === day ? theme.colors.accentBg : 'bg-transparent'}`}/>
                      <span className={`text-[10px] uppercase font-black opacity-50 mt-2 ${activeDay === day ? theme.colors.accent : theme.colors.subtext}`}>Day</span>
                      <span className="text-xl font-bold font-mono">{day}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          );
        };

        // --- V2.1: Stable Leaflet Map (Fixes White Screen & CSS) ---
        const LeafletMap = ({ items, activeRegion, theme, setActiveRegion, setEditingItem }) => {
          const mapContainerRef = useRef(null);
          const mapInstanceRef = useRef(null);
          const markersRef = useRef([]);
          const polylineRef = useRef(null);
          const [isLoading, setIsLoading] = useState(true);

          // 1. Robust Script Loading
          useEffect(() => {
            const loadLeaflet = async () => {
              if (document.getElementById('leaflet-css') || window.L) {
                 if (window.L) { initMap(); setIsLoading(false); }
                 return;
              }
              
              const link = document.createElement('link');
              link.id = 'leaflet-css';
              link.rel = 'stylesheet';
              link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
              document.head.appendChild(link);

              const script = document.createElement('script');
              script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
              script.async = true;
              script.onload = () => {
                initMap();
                setIsLoading(false);
              };
              document.head.appendChild(script);
            };
            loadLeaflet();
            return () => {
                if (mapInstanceRef.current) { mapInstanceRef.current.remove(); mapInstanceRef.current = null; }
            };
          }, []);

          // 2. Initialize Map with size invalidation fix
          const initMap = () => {
            if (mapInstanceRef.current || !mapContainerRef.current || !window.L) return;
            
            const region = REGION_COORDS[activeRegion];
            const map = window.L.map(mapContainerRef.current, {
                zoomControl: false,
                attributionControl: false
            }).setView([region.lat, region.lng], region.zoom);

            // Force re-layout to prevent gray/blank tiles
            setTimeout(() => { map.invalidateSize(); }, 200);
            
            mapInstanceRef.current = map;
          };

          // 3. Update Layers & View
          useEffect(() => {
              if (!mapInstanceRef.current || !window.L) return;
              const map = mapInstanceRef.current;
              map.eachLayer(layer => { if (layer instanceof window.L.TileLayer) map.removeLayer(layer); });
              window.L.tileLayer(theme.tileLayer, { attribution: theme.attribution, maxZoom: 19 }).addTo(map);
              const region = REGION_COORDS[activeRegion];
              map.flyTo([region.lat, region.lng], region.zoom);
              setTimeout(() => map.invalidateSize(), 200); // Critical fix
          }, [activeRegion, theme]);

          // 4. Render Markers & Path
          useEffect(() => {
              if (!mapInstanceRef.current || !window.L) return;
              const map = mapInstanceRef.current;

              markersRef.current.forEach(m => map.removeLayer(m)); markersRef.current = [];
              if (polylineRef.current) map.removeLayer(polylineRef.current);

              const pathCoords = [];
              const validItems = items.filter(item => {
                  if (!item.coordinates || !item.coordinates.lat) {
                      const key = Object.keys(REAL_LOCATIONS).find(k => item.location.toLowerCase().includes(k.toLowerCase()));
                      if (key) { item.coordinates = REAL_LOCATIONS[key]; return true; }
                      return false;
                  }
                  return true;
              });

              validItems.forEach((item, index) => {
                  const { lat, lng } = item.coordinates;
                  const color = CATEGORIES[item.category]?.hex || (theme.colors.accentBg.includes('cyan') ? '#06b6d4' : '#ec4899');
                  
                  const iconHtml = `
                    <div style="background-color: ${color}; width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 8px rgba(0,0,0,0.4); color: white; font-weight: bold; font-size: 12px;">${index + 1}</div>
                  `;
                  const customIcon = window.L.divIcon({ className: 'custom-marker-icon', html: iconHtml, iconSize: [28, 28], iconAnchor: [14, 14], popupAnchor: [0, -14] });
                  const marker = window.L.marker([lat, lng], { icon: customIcon }).addTo(map)
                      .bindPopup(`<div style="font-family: system-ui; min-width: 160px;"><strong style="font-size: 14px;">${item.title}</strong><br/><span style="color: #666; font-size: 12px;">${item.time}</span><br/><a href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}" target="_blank" style="display: block; margin-top: 8px; padding: 6px; background: #3b82f6; color: white; text-decoration: none; font-weight: bold; font-size: 12px; text-align: center; border-radius: 6px;">導航 (Google Maps)</a></div>`)
                      // V2.1.1: Center map on marker click
                      .on('click', () => {
                          map.flyTo([lat, lng], 16, { animate: true, duration: 1.5 });
                      });

                  markersRef.current.push(marker);
                  pathCoords.push([lat, lng]);
              });

              if (pathCoords.length > 0) {
                  const color = theme.colors.accentBg.includes('cyan') ? '#06b6d4' : '#ec4899';
                  polylineRef.current = window.L.polyline(pathCoords, { color: color, weight: 4, opacity: 0.8, dashArray: '5, 10' }).addTo(map);
                  if (pathCoords.length > 1) map.fitBounds(window.L.latLngBounds(pathCoords).pad(0.2));
              }
          }, [items, theme]);

          // Custom Controls
          const handleZoomIn = () => { if(mapInstanceRef.current) mapInstanceRef.current.zoomIn(); };
          const handleZoomOut = () => { if(mapInstanceRef.current) mapInstanceRef.current.zoomOut(); };
          const handleAutoLocate = () => { 
              if (!mapInstanceRef.current || items.length === 0) return; 
              const now = new Date(); const currentMinutes = now.getHours() * 60 + now.getMinutes(); 
              const sorted = [...items].filter(i=>i.coordinates).sort((a, b) => { const [h1, m1] = a.time.split(':').map(Number); const [h2, m2] = b.time.split(':').map(Number); return (h1 * 60 + m1) - (h2 * 60 + m2); }); 
              let target = sorted[0]; 
              const upcoming = sorted.find(p => { const [h, m] = p.time.split(':').map(Number); return (h * 60 + m) >= currentMinutes; }); 
              if (upcoming) target = upcoming; else if (sorted.length > 0) target = sorted[sorted.length - 1]; 
              
              if(target && target.coordinates) {
                 mapInstanceRef.current.flyTo([target.coordinates.lat, target.coordinates.lng], 16);
              }
          };

          return (
            <div className="w-full h-full relative">
               {isLoading && (
                   <div className={`absolute inset-0 z-20 flex items-center justify-center ${theme.colors.bg}`}>
                       <div className="flex flex-col items-center"><Loader2 size={32} className={`animate-spin ${theme.colors.accent}`} /><span className={`mt-2 text-xs ${theme.colors.subtext}`}>載入地圖資源...</span></div>
                   </div>
               )}
               <div ref={mapContainerRef} className="w-full h-full z-0" style={{ background: theme.colors.bg, isolation: 'isolate' }} />
               <div className="absolute top-4 left-4 z-[400] flex flex-col gap-2">
                 <div className={`${theme.colors.cardBlur} backdrop-blur border ${theme.colors.border} p-1 rounded-xl flex flex-col gap-1 shadow-lg`}>
                    {Object.entries(REGION_COORDS).map(([key, val]) => (
                        <button key={key} onClick={() => setActiveRegion(key)} className={`px-3 py-2 rounded-lg text-xs font-bold transition-all ${activeRegion === key ? `${theme.colors.accentBg} text-white shadow` : `${theme.colors.subtext} hover:${theme.colors.bg}`}`}>{val.name}</button>
                    ))}
                 </div>
              </div>
              <div className="absolute top-20 right-4 z-[500] flex flex-col gap-3 pointer-events-auto">
                <div className={`${theme.colors.cardBlur} backdrop-blur rounded-xl border ${theme.colors.border} overflow-hidden flex flex-col shadow-lg`}>
                    <button onClick={handleZoomIn} className={`p-3 ${theme.colors.accent} hover:${theme.colors.bg} border-b ${theme.colors.border}`}><ZoomIn size={20}/></button>
                    <button onClick={handleZoomOut} className={`p-3 ${theme.colors.accent} hover:${theme.colors.bg}`}><ZoomOut size={20}/></button>
                </div>
                <button onClick={handleAutoLocate} className={`p-3 ${theme.colors.accentBg} text-white rounded-full shadow-lg border ${theme.colors.accentBorder} hover:opacity-90 active:scale-95 transition-transform`}><LocateFixed size={20}/></button>
              </div>
            </div>
          );
        };

        // --- Search Tab ---
        const SearchTab = ({ itinerary, setActiveDay, setEditingItem, setViewMode, theme }) => {
          const [query, setQuery] = useState(''); const [localResults, setLocalResults] = useState([]);
          useEffect(() => { if (!query.trim()) { setLocalResults([]); return; } const lowerQuery = query.toLowerCase(); setLocalResults(itinerary.filter(item => item.title.toLowerCase().includes(lowerQuery) || item.location.toLowerCase().includes(lowerQuery))); }, [query, itinerary]);
          const getSearchUrl = (type, keyword) => { const encoded = encodeURIComponent(keyword.includes('東京')?keyword:`東京 ${keyword}`); switch (type) { case 'google': return `https://www.google.com/search?q=${encoded}`; case 'maps': return `https://www.google.com/maps/search/?api=1&query=${encoded}`; case 'images': return `https://www.google.com/search?tbm=isch&q=${encoded}`; case 'hotel': return `https://www.google.com/maps/search/hotels+near+${encoded}`; default: return '#'; }};

          return (
            <div className="flex flex-col h-full p-5 space-y-6 pb-24 animate-fadeIn">
              <div className="relative group"><Search className={`absolute left-4 top-3.5 ${theme.colors.subtext} group-focus-within:${theme.colors.accent} transition-colors`} size={20} /><input type="text" value={query} onChange={(e) => setQuery(e.target.value)} placeholder="搜尋行程資料庫..." className={`w-full ${theme.colors.card} pl-12 pr-4 py-3 rounded-xl ${theme.colors.text} outline-none border ${theme.colors.border} focus:${theme.colors.accentBorder} transition-all placeholder-slate-500`} autoFocus/>{query && <button onClick={() => setQuery('')} className={`absolute right-3 top-3.5 ${theme.colors.subtext} hover:${theme.colors.text}`}><X size={18} /></button>}</div>
              {query && (
                <div className="animate-fadeIn">
                    <div className={`text-xs font-bold ${theme.colors.subtext} uppercase tracking-wider ml-1 mb-2`}>進階搜尋</div>
                    <div className="grid grid-cols-2 gap-3">
                        <a href={getSearchUrl('maps', query)} target="_blank" rel="noopener noreferrer" className={`${theme.colors.card} p-3 rounded-xl flex items-center gap-3 ${theme.colors.subtext} hover:${theme.colors.bg} hover:${theme.colors.text} border ${theme.colors.border} transition-colors`}><MapPin size={18} className="text-red-400"/> <span className="text-sm font-bold">Google 地圖</span></a>
                        <a href={getSearchUrl('images', query)} target="_blank" rel="noopener noreferrer" className={`${theme.colors.card} p-3 rounded-xl flex items-center gap-3 ${theme.colors.subtext} hover:${theme.colors.bg} hover:${theme.colors.text} border ${theme.colors.border} transition-colors`}><Image size={18} className="text-yellow-400"/> <span className="text-sm font-bold">圖片搜尋</span></a>
                        <a href={getSearchUrl('hotel', query)} target="_blank" rel="noopener noreferrer" className={`col-span-2 ${theme.colors.card} p-3 rounded-xl flex items-center justify-center gap-3 ${theme.colors.subtext} hover:${theme.colors.bg} hover:${theme.colors.text} border ${theme.colors.border} transition-colors`}><Hotel size={18} className="text-purple-400"/> <span className="text-sm font-bold">找附近飯店</span></a>
                    </div>
                    {localResults.length === 0 && (
                        <a href={getSearchUrl('google', query)} target="_blank" className={`mt-3 block ${theme.colors.card} border ${theme.colors.border} p-4 rounded-xl flex items-center justify-between ${theme.colors.subtext} hover:${theme.colors.accent} transition-all group`}><span>在 Google 搜尋 "{query}"</span><ExternalLink size={16} /></a>
                    )}
                </div>
              )}
              {localResults.length > 0 && (
                <div className="space-y-3">
                   <div className={`text-xs font-bold ${theme.colors.subtext} uppercase tracking-wider ml-1`}>行程內結果 ({localResults.length})</div>
                   {localResults.map(item => { const cat = CATEGORIES[item.category] || CATEGORIES.other; return (<div key={item.id} onClick={() => { setActiveDay(item.day); setEditingItem(item); setViewMode('list'); }} className={`${theme.colors.card} p-3 rounded-xl border ${theme.colors.border} flex gap-3 items-center cursor-pointer hover:opacity-80 transition-all`}><div className={`w-10 h-10 rounded-lg flex items-center justify-center ${cat.bg} ${cat.text}`}>{cat.icon}</div><div><div className={`${theme.colors.text} font-bold`}>{item.title}</div><div className={`${theme.colors.subtext} text-xs`}>Day {item.day} • {item.time}</div></div></div>)})}
                </div>
              )}
            </div>
          );
        };

        const EditModal = ({ editingItem, setEditingItem, travelers, handleSave, handleDelete, theme }) => {
          const [data, setData] = useState({ ...editingItem });
          const [cost, setCost] = useState(editingItem.cost || { total: 0, payer: travelers[0], mode: 'even', targets: {}, customAmounts: {} });
          const [isDeleting, setIsDeleting] = useState(false);
          const [isLocating, setIsLocating] = useState(false);

          useEffect(() => { if (!cost.targets || Object.keys(cost.targets).length === 0) { const t = {}; travelers.forEach(m => t[m] = true); setCost(prev => ({ ...prev, targets: t })); } }, []);
          const updateCost = (k, v) => setCost(p => ({ ...p, [k]: v }));
          const handleFileUpload = (e) => { const file = e.target.files[0]; if (file) { const objectUrl = URL.createObjectURL(file); setData(prev => ({ ...prev, image: objectUrl })); }};
          const setRandomImage = () => { const randomId = Math.floor(Math.random() * 1000); const url = `https://source.unsplash.com/random/800x600/?tokyo,travel,japan&sig=${randomId}`; setData(prev => ({ ...prev, image: url })); };

          const handleAutoLocate = async () => {
            if(!data.location) return;
            setIsLocating(true);
            if (data.location.includes('google.com/maps')) {
               const latMatch = data.location.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
               const nameMatch = data.location.match(/place\/([^/]+)/);
               if (latMatch) {
                   setData(prev => ({
                       ...prev, 
                       coordinates: { lat: parseFloat(latMatch[1]), lng: parseFloat(latMatch[2]) },
                       location: nameMatch ? decodeURIComponent(nameMatch[1].replace(/\+/g, ' ')) : prev.location
                   }));
                   setIsLocating(false);
                   return;
               }
            }
            const coords = await fetchCoordinates(data.location);
            if(coords) { setData(prev => ({...prev, coordinates: coords})); }
            setIsLocating(false);
          };

          const updateCoordinate = (field, value) => {
            const numVal = parseFloat(value);
            setData(prev => ({ ...prev, coordinates: { ...prev.coordinates, [field]: isNaN(numVal) ? 0 : numVal } }));
          };

          const confirmDelete = () => { handleDelete(data.id); };

          return (
            <div className="fixed inset-0 z-[100] flex items-end justify-center bg-black/60 backdrop-blur-sm animate-fadeIn p-4 pb-0">
              <div className={`${theme.colors.bg} w-full max-w-lg rounded-t-3xl p-6 h-[85vh] overflow-y-auto border ${theme.colors.border} shadow-2xl relative`}>
                <div className="flex justify-between items-center mb-6"><h2 className={`text-xl font-bold ${theme.colors.text} flex items-center gap-2`}><Edit3 size={18} className={theme.colors.accent}/> 編輯行程</h2><button onClick={() => setEditingItem(null)} className={`p-2 ${theme.colors.card} rounded-full ${theme.colors.subtext} hover:${theme.colors.text}`}><X size={20}/></button></div>
                <div className="space-y-5">
                   <div className="grid grid-cols-3 gap-3">
                     <div className="col-span-1"><label className={`text-[10px] ${theme.colors.subtext} font-bold uppercase mb-1 block`}>時間</label><input type="time" value={data.time} onChange={e=>setData({...data, time:e.target.value})} className={`w-full ${theme.colors.card} border ${theme.colors.border} rounded-lg p-3 ${theme.colors.text} outline-none focus:${theme.colors.accentBorder}`}/></div>
                     <div className="col-span-2"><label className={`text-[10px] ${theme.colors.subtext} font-bold uppercase mb-1 block`}>標題</label><input type="text" value={data.title} onChange={e=>setData({...data, title:e.target.value})} className={`w-full ${theme.colors.card} border ${theme.colors.border} rounded-lg p-3 ${theme.colors.text} outline-none focus:${theme.colors.accentBorder}`} placeholder="行程名稱..."/></div>
                   </div>
                   <div><label className={`text-[10px] ${theme.colors.subtext} font-bold uppercase mb-1 block`}>圖片</label><div className="flex gap-2"><input type="text" value={data.image || ''} onChange={e=>setData({...data, image: e.target.value})} className={`flex-1 p-3 ${theme.colors.card} rounded-xl text-xs outline-none border ${theme.colors.border} ${theme.colors.text} placeholder-slate-500 focus:${theme.colors.accentBorder}`} placeholder="https://..."/><label className={`px-3 ${theme.colors.bg} border ${theme.colors.border} rounded-xl flex items-center justify-center cursor-pointer hover:opacity-80 ${theme.colors.subtext}`}><input type="file" accept="image/*" className="hidden" onChange={handleFileUpload} /><Upload size={16}/></label><button onClick={setRandomImage} className={`px-3 ${theme.colors.bg} border ${theme.colors.border} ${theme.colors.accent} rounded-xl text-xs font-bold hover:opacity-80 whitespace-nowrap flex items-center gap-1`}><RefreshCw size={12}/> 隨機</button></div></div>
                   
                   <div>
                     <label className={`text-[10px] ${theme.colors.subtext} font-bold uppercase mb-1 block`}>地點 / Google Maps 連結</label>
                     <div className="flex gap-2 mb-2">
                        <input type="text" value={data.location} onChange={e=>setData({...data, location:e.target.value})} className={`flex-1 ${theme.colors.card} border ${theme.colors.border} rounded-lg p-3 ${theme.colors.text} outline-none focus:${theme.colors.accentBorder}`} placeholder="輸入地名 或 貼上 Google Maps 網址"/>
                        <button onClick={handleAutoLocate} disabled={isLocating} className={`px-3 ${theme.colors.accentBg} text-white rounded-lg text-xs font-bold whitespace-nowrap hover:opacity-90 flex items-center gap-1 shadow-lg`}>
                            {isLocating ? <Loader2 size={14} className="animate-spin"/> : (data.location?.includes('http') ? <Wand2 size={14}/> : <MapPin size={14}/>)}
                            {isLocating ? '處理中' : (data.location?.includes('http') ? '解析' : '自動定位')}
                        </button>
                     </div>
                     <div className="flex gap-2">
                       <div className="flex-1 relative">
                          <span className={`absolute left-3 top-1/2 -translate-y-1/2 ${theme.colors.subtext} text-[10px] pointer-events-none`}>緯度</span>
                          <input type="number" step="0.0001" value={data.coordinates?.lat || ''} onChange={(e) => updateCoordinate('lat', e.target.value)} className={`w-full ${theme.colors.card} border ${theme.colors.border} rounded-lg py-2 pl-10 pr-2 text-xs ${theme.colors.text} outline-none focus:${theme.colors.accentBorder}`} placeholder="35.xxxx"/>
                       </div>
                       <div className="flex-1 relative">
                          <span className={`absolute left-3 top-1/2 -translate-y-1/2 ${theme.colors.subtext} text-[10px] pointer-events-none`}>經度</span>
                          <input type="number" step="0.0001" value={data.coordinates?.lng || ''} onChange={(e) => updateCoordinate('lng', e.target.value)} className={`w-full ${theme.colors.card} border ${theme.colors.border} rounded-lg py-2 pl-10 pr-2 text-xs ${theme.colors.text} outline-none focus:${theme.colors.accentBorder}`} placeholder="139.xxxx"/>
                       </div>
                     </div>
                   </div>

                   <div className={`${theme.colors.card} p-4 rounded-xl border ${theme.colors.border} space-y-4`}>
                      <div className={`flex items-center gap-2 ${theme.colors.subtext} font-bold border-b ${theme.colors.border} pb-2`}><Wallet size={16}/> 費用與分帳</div>
                      <div className="flex gap-3"><div className="flex-1"><label className={`text-[10px] ${theme.colors.subtext} block mb-1`}>總金額 (¥)</label><input type="number" value={cost.total} onChange={e=>updateCost('total', parseFloat(e.target.value)||0)} className={`w-full ${theme.colors.bg} border ${theme.colors.border} rounded p-2 ${theme.colors.text} font-mono`}/></div><div className="flex-1"><label className={`text-[10px] ${theme.colors.subtext} block mb-1`}>先付者</label><select value={cost.payer} onChange={e=>updateCost('payer', e.target.value)} className={`w-full ${theme.colors.bg} border ${theme.colors.border} rounded p-2 ${theme.colors.text}`}>{travelers.map(t=><option key={t} value={t}>{t}</option>)}</select></div></div>
                      <div className="space-y-1">{travelers.map(t => { const active = cost.targets?.[t] !== false; return (<div key={t} onClick={() => updateCost('targets', { ...cost.targets, [t]: !active })} className={`flex items-center justify-between p-2 rounded cursor-pointer border ${active ? `${theme.colors.bg} ${theme.colors.accentBorder}` : 'border-transparent opacity-50'}`}><span className={`text-sm ${theme.colors.subtext}`}>{t}</span>{active && <Check size={14} className={theme.colors.accent}/>}</div>)})}</div>
                   </div>
                   
                   <div className="flex gap-3 pt-4 pb-8">
                     {isDeleting ? (
                       <>
                         <button onClick={() => setIsDeleting(false)} className={`flex-1 py-3 rounded-xl ${theme.colors.card} ${theme.colors.text} border ${theme.colors.border} font-bold`}>取消</button>
                         <button onClick={confirmDelete} className="flex-[2] py-3 rounded-xl bg-red-600 text-white font-bold shadow-lg hover:bg-red-700 flex items-center justify-center gap-2"><AlertTriangle size={18}/> 確定刪除</button>
                       </>
                     ) : (
                       <>
                         <button onClick={() => setIsDeleting(true)} className="flex-1 py-3 rounded-xl border border-red-900/30 text-red-400 hover:bg-red-900/10 font-bold">刪除行程</button>
                         <button onClick={() => handleSave({ ...data, cost })} className={`flex-[2] py-3 rounded-xl ${theme.colors.accentBg} text-white font-bold shadow-lg hover:opacity-90`}>儲存變更</button>
                       </>
                     )}
                   </div>
                </div>
              </div>
            </div>
          );
        };

        const TimelineList = ({ items, setEditingItem, handleAddItem, theme }) => {
          return (
            <div className="p-5 pb-32">
               {items.length === 0 ? (
                 <div className={`text-center py-20 opacity-50 ${theme.colors.subtext} flex flex-col items-center`}>
                   <div className={`w-16 h-16 ${theme.colors.card} rounded-full flex items-center justify-center mb-4`}><Calendar size={32} /></div>
                   <p>Day 尚無行程</p>
                   <button onClick={handleAddItem} className={`mt-4 ${theme.colors.accent} text-sm font-bold hover:underline`}>點擊新增</button>
                 </div>
               ) : (
                 <div className="relative">
                   <div className={`absolute left-4 top-4 bottom-4 w-0.5 ${theme.colors.border} border-l-2 border-dashed opacity-30`}></div>
                   <div className="space-y-6">
                     {items.map((item, idx) => {
                       const cat = CATEGORIES[item.category] || CATEGORIES.other;
                       return (
                         <div key={item.id} className="relative pl-12 group animate-slideUp" style={{ animationDelay: `${idx * 50}ms` }}>
                           <div className={`absolute left-[11px] top-6 w-3 h-3 rounded-full border-2 z-10 ${theme.colors.bg} ${cat.border} ${cat.text} shadow-sm`}></div>
                           <div onClick={() => setEditingItem(item)} className={`${theme.colors.cardBlur} backdrop-blur-sm rounded-2xl border ${theme.colors.border} overflow-hidden hover:opacity-90 transition-all cursor-pointer shadow-sm hover:shadow-md`}>
                             <div className={`h-28 w-full ${theme.colors.bg} relative overflow-hidden`}>
                               {item.image ? (<img src={item.image} alt={item.title} className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity duration-500" />) : (<div className={`w-full h-full flex items-center justify-center ${theme.colors.subtext} ${theme.colors.bg} pattern-grid`}><ImageIcon size={24} /></div>)}
                               <div className={`absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent`}/>
                               <div className="absolute top-2 left-2 bg-black/40 backdrop-blur text-white px-3 py-1 rounded-full text-xs font-mono font-bold border border-white/10 flex items-center gap-2"><Clock size={10} className={theme.colors.accent}/> {item.time}</div>
                               <div className={`absolute top-2 right-2 px-2 py-0.5 rounded text-[10px] font-bold ${cat.bg} ${cat.text} border ${cat.border} backdrop-blur-md`}>{cat.label}</div>
                             </div>
                             <div className="p-4 relative">
                               <div className="flex justify-between items-start"><h3 className={`font-bold text-lg ${theme.colors.text} line-clamp-1`}>{item.title}</h3>{item.cost?.total > 0 && <span className={`text-xs font-mono font-bold ${theme.colors.highlight} ${theme.colors.bg} px-2 py-1 rounded border ${theme.colors.border}`}>¥{item.cost.total.toLocaleString()}</span>}</div>
                               <div className="flex items-center justify-between mt-3"><div className={`flex items-center gap-1.5 text-xs ${theme.colors.subtext} truncate max-w-[70%]`}><MapPin size={12} className={theme.colors.subtext}/> {item.location}</div><div className={`w-8 h-8 rounded-full ${theme.colors.bg} flex items-center justify-center ${theme.colors.accent} border ${theme.colors.border}`}><Navigation size={14}/></div></div>
                             </div>
                           </div>
                         </div>
                       );
                     })}
                   </div>
                 </div>
               )}
               <button onClick={handleAddItem} className={`fixed bottom-24 right-6 ${theme.colors.accentBg} text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:scale-110 active:scale-95 transition-all z-30 group`}><Plus size={28} className="group-hover:rotate-90 transition-transform duration-300"/></button>
            </div>
          );
        };

        function App() {
          const [currentTheme, setTheme] = useState(THEMES.cyberpunk);
          const [itinerary, setItinerary] = useState(INITIAL_ITINERARY);
          const [activeDay, setActiveDay] = useState(1);
          const [viewMode, setViewMode] = useState('list');
          const [travelers, setTravelers] = useState(DEFAULT_MEMBERS);
          const [totalDays, setTotalDays] = useState(6);
          const [editingItem, setEditingItem] = useState(null);
          const [showBudgetModal, setShowBudgetModal] = useState(false);
          const [activeRegion, setActiveRegion] = useState('tokyo'); 
          const contentRef = useRef(null);

          useEffect(() => { if (contentRef.current) contentRef.current.scrollTop = 0; }, [viewMode]);

          const dayItems = itinerary.filter(i => i.day === activeDay).sort((a, b) => a.time.localeCompare(b.time));
          const handleAddItem = () => { const initialTargets = {}; travelers.forEach(t => initialTargets[t] = true); setEditingItem({ id: Date.now().toString(), day: activeDay, time: '12:00', title: '', category: 'other', location: '', notes: '', image: '', mapUrl: '', cost: { total: 0, payer: travelers[0], mode: 'even', targets: initialTargets, customAmounts: {} }}); };
          const handleSave = (item) => { setItinerary(prev => { const exists = prev.find(i => i.id === item.id); return exists ? prev.map(i => i.id === item.id ? item : i) : [...prev, item]; }); setEditingItem(null); };
          
          const handleDelete = (id) => { 
              setItinerary(prev => prev.filter(i => i.id !== id)); 
              setEditingItem(null);
          };

          return (
            <div className={`h-[100dvh] ${currentTheme.colors.bg} font-sans ${currentTheme.colors.text} overflow-hidden flex flex-col relative transition-colors duration-500`}>
              <DashboardHeader memberCount={travelers.length} activeDay={activeDay} onDayChange={setActiveDay} totalDays={totalDays} theme={currentTheme} activeRegion={activeRegion}/>
              
              <div ref={contentRef} className="flex-1 overflow-y-auto relative scroll-smooth">
                {viewMode === 'list' && <TimelineList items={dayItems} setEditingItem={setEditingItem} handleAddItem={handleAddItem} theme={currentTheme} />}
                {viewMode === 'map' && <LeafletMap items={dayItems} activeRegion={activeRegion} theme={currentTheme} setActiveRegion={setActiveRegion} setEditingItem={setEditingItem}/>}
                {viewMode === 'search' && <SearchTab itinerary={itinerary} setActiveDay={setActiveDay} setEditingItem={setEditingItem} setViewMode={setViewMode} theme={currentTheme} />}
                {viewMode === 'settings' && <SettingsTab totalDays={totalDays} setTotalDays={setTotalDays} travelers={travelers} setTravelers={setTravelers} currentTheme={currentTheme} setTheme={setTheme}/>}
              </div>
              <div className={`fixed bottom-0 w-full ${currentTheme.colors.navBar} backdrop-blur-xl border-t ${currentTheme.colors.border} px-4 py-3 pb-6 flex justify-between items-center z-40 shadow-lg transition-colors duration-500`}>
                {[{ id: 'list', icon: List, label: '行程' }, { id: 'map', icon: MapIcon, label: '地圖' }, { id: 'search', icon: Search, label: '搜尋' }, { id: 'budget', icon: PieChart, label: '預算', action: () => setShowBudgetModal(true) }, { id: 'settings', icon: Settings, label: '設定' }].map(btn => (
                  <button key={btn.id} onClick={btn.action || (() => setViewMode(btn.id))} className={`flex flex-col items-center justify-center w-16 h-14 rounded-2xl transition-all duration-300 group ${viewMode === btn.id && !btn.action ? `${currentTheme.colors.text} ${currentTheme.colors.card}` : `${currentTheme.colors.subtext} hover:${currentTheme.colors.text}`}`}>
                    <btn.icon size={22} strokeWidth={viewMode === btn.id && !btn.action ? 2.5 : 2} className={`mb-1 transition-transform group-hover:scale-110 ${viewMode === btn.id && !btn.action ? `drop-shadow-sm ${currentTheme.colors.accent}` : ''}`}/><span className="text-[9px] font-bold tracking-wide opacity-80">{btn.label}</span>
                  </button>
                ))}
              </div>
              <BudgetReportModal isOpen={showBudgetModal} onClose={() => setShowBudgetModal(false)} itinerary={itinerary} travelers={travelers} theme={currentTheme}/>
              {editingItem && <EditModal key={editingItem.id} editingItem={editingItem} setEditingItem={setEditingItem} travelers={travelers} handleSave={handleSave} handleDelete={handleDelete} theme={currentTheme}/>}
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>